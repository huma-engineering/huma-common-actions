name: Uninstall the Huma Server SDK Helm chart
description: Uninstall the Huma Server SDK Helm chart
inputs:
  server_name: { required: true, description: ''}
  cluster_name: { required: false, description: '' }
  cluster_location: { required: false, description: '' }
  grafana_host: { required: true, description: '' }
  issue_number: { required: true, description: '' }
  gke_sa_key: { required: true, description: '' }
  grafana_api_key: { required: true, description: '' }

runs:
  using: composite
  steps:
    - id: helm
      name: Uninstall a Helm chart
      uses: huma-engineering/huma-github-actions/uninstall-helm-chart@v0.14.0
      with:
        cluster_name: ${{ inputs.cluster_name }}
        location: ${{ inputs.cluster_location }}
        app_name: ${{ inputs.server_name }}-${{ inputs.issue_number }}
        app_namespace: pr-preview-${{ inputs.server_name }}-${{ inputs.issue_number }}
        delete_namespace: "true"
        gcp_credentials: ${{ inputs.gke_sa_key }}

    - name: put a comment on success
      if: steps.helm.outputs.error == 0
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ inputs.issue_number }}
        body: |-
          Uninstalled the ${{ inputs.server_name }} application's Helm chart.ğŸ‘Œ
          Removed the connected storage bucket, database and cache.
          [The corresponding Github CI workflow run](${{ format('{0}/{1}/actions/runs/{2}',
            github.server_url, github.repository, github.run_id) }})

    - name: put a comment on failure
      if: steps.helm.outputs.error != 0
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ inputs.issue_number }}
        body: |-
          Failed to uninstall the ${{ inputs.server_name }} application's Helm chart.âŒ
          [The corresponding Github CI workflow run](${{ format('{0}/{1}/actions/runs/{2}',
            github.server_url, github.repository, github.run_id) }})

    - if: steps.helm.outputs.error == 0
      uses: actions-ecosystem/action-remove-labels@v1
      with:
        labels: deployed

    - if: steps.helm.outputs.error == 0
      uses: actions-ecosystem/action-remove-labels@v1
      with:
        labels: deployed_atlas_mongodb

    - if: steps.helm.outputs.error == 0
      uses: actions-ecosystem/action-remove-labels@v1
      with:
        labels: deployed_gcs_bucket

    - name: remove Grafana logs dashboard
      if: steps.helm.outputs.error == 0
      id: dashboard
      uses: huma-engineering/huma-github-actions/remove-grafana-dashboard@v0.14.0
      with:
        title: ${{ inputs.server_name }}-${{ inputs.issue_number }}-logs
        grafana_api_key: ${{ inputs.grafana_api_key }}
        grafana_host: ${{ inputs.grafana_host }}

    - name: comment on remove dashboard success
      if: ${{ steps.dashboard.outputs.error == 0 }}
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ inputs.issue_number }}
        body: ${{ steps.dashboard.outputs.response }}ğŸ‘Œ

    - name: comment on remove dashboard failure
      if: ${{ steps.dashboard.outputs.error != 0 }}
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ inputs.issue_number }}
        body: Dashboard not foundâŒ
