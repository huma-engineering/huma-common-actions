name: Mega pipeline

on:
  workflow_call:
    inputs:
      server_name: { required: true, type: string }
      include_sdk: { required: true, type: boolean }
      sdk_ref: { required: false, type: string }
      cluster_name: { required: false, type: string, default: 'hu-uk-sandbox-pr-preview-gke' }
      cluster_location: { required: false, type: string, default: 'europe-west2' }
      atlas_cluster: { required: false, type: string, default: 'hu-uk-sandbox-pr-preview' }
      atlas_project: { required: false, type: string, default: 'hu-sandbox' }
      atlas_project_url: { required: false, type: string }
      db_dump_bucket_name: { required: false, type: string }
      kubedb_cluster: { required: true, type: string }
      kubedb_namespace: { required: false, type: string }
      grafana_host: { required: true, type: string }
      grafana_cluster_name: { required: true, type: string }
      host_postfix: { required: false, type: string, default: 'sbx.huma.com' }
      source_gcs_bucket_qa: { required: true, type: string }
      source_gcs_bucket_dev: { required: true, type: string }
      source_s3_bucket_qa: { required: true, type: string }
      source_s3_bucket_dev: { required: true, type: string }
      make_upload_chart_command: { required: true, type: string }
      aws_region: { required: false, type: string, default: 'eu-west-2' }
      dockerfile: { required: true, type: string }
      make_build_push_ghcr: { required: true, type: string }
      docker_image_name: { required: true, type: string, description: 'Docker image name of make file' }
      docker_temp_tag_format: { required: true, type: string, description: 'Docker tag format in PRs' }
      helm_extra_values_file: { required: true, type: string }
      server_extra_config_file: { required: true, type: string }
      dev_mongo_db_name: { required: true, type: string }
      qa_mongo_db_name: { required: true, type: string }
      mongo_dump_extra_options: { required: true, type: string }
      server_py: { required: true, type: string }
      migrate_py: { required: true, type: string }
      migrate_config: { required: true, type: string }
      version_py: { required: true, type: string }
      enable_publish: { required: false, type: boolean, default: false }

env:
  must_build: ${{
    startsWith(github.event.comment.body, '/deploy') ||
    (startsWith(github.event.comment.body, '/rebuild') &&
    contains(github.event.issue.labels.*.name, 'deployed')) }}
  app_name: ${{ inputs.server_name }}-${{ github.event.issue.number }}
  app_namespace: pr-preview-${{ inputs.server_name }}-${{ github.event.issue.number }}
  bucket_provider: ${{
    (startsWith(github.event.comment.body, '/deploy') &&
    (contains(github.event.comment.body, '--storage=gcs') && 'gcs' || 's3')) ||
    (startsWith(github.event.comment.body, '/rebuild') &&
    (contains(github.event.issue.labels.*.name, 'deployed_gcs_bucket') && 'gcs' || 's3')) }}
  db_provider: ${{
    (startsWith(github.event.comment.body, '/deploy') &&
    (contains(github.event.comment.body, '--mongodb=atlas') && 'atlas' || 'kubedb')) ||
    (startsWith(github.event.comment.body, '/rebuild') &&
    (contains(github.event.issue.labels.*.name, 'deployed_atlas_mongodb') && 'atlas' || 'kubedb')) }}
  db_user: ${{ inputs.server_name }}-${{ github.event.issue.number }}-db
  full_db_dump_prefix: ${{ contains(github.event.comment.body, '--db-full') && 'full_' || '' }}
  host_postfix: ${{ inputs.server_name }}-${{ github.event.issue.number }}.${{ inputs.host_postfix }}
  source_db_name: ${{ contains(github.event.comment.body, '--env=qa') && 'pp_qa' || 'pp_dev' }}
  source_gcs_bucket: ${{ contains(github.event.comment.body, '--env=qa') &&
    inputs.source_gcs_bucket_qa || inputs.source_gcs_bucket_dev }}
  source_s3_bucket: ${{ contains(github.event.comment.body, '--env=qa') &&
    inputs.source_s3_bucket_qa || inputs.source_s3_bucket_dev }}
  update_chart: ${{ contains(github.event.comment.body, '--update-chart') && true || false }}
  issue_number: ${{ github.event.action == 'created' && github.event.issue.number ||
            github.event.pull_request.number }}
  mongo_dev_uri: ${{ secrets.MONGO_DEV_URI }}
  # mongo_dev_uri: ${{ format('mongodb+srv://{0}:{1}@{2}/{3}',
  #     secrets.MONGO_PRE_PROD_USER_NAME,
  #     secrets.MONGO_PRE_PROD_USER_PWD,
  #     secrets.MONGO_PRE_PROD_HOST,
  #     inputs.dev_mongo_db_name
  #   ) }}
  mongo_qa_uri: ${{ format('mongodb+srv://{0}:{1}@{2}/{3}',
      secrets.MONGO_PRE_PROD_USER_NAME,
      secrets.MONGO_PRE_PROD_USER_PWD,
      secrets.MONGO_PRE_PROD_HOST,
      inputs.qa_mongo_db_name
    ) }}
  is_publish_task: ${{ github.event_name == 'push' &&
    inputs.enable_publish == 'true' &&
    (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/heads/release-')) }}
  vpn_config_url: https://api.perimeter81.com/api/networks/XkBbhFGBtm/tunnels/ZlUsofhzlD/openvpn-config/download

# yamllint disable rule:line-length
jobs:
  # /deploy and /rebuild flow
  deploy-task:
    name: Check if this flow must be run at all or not
    runs-on: ubuntu-latest
    outputs:
      is_deploy: ${{ steps.action.outputs.is_deploy }}
      is_rebuild: ${{ steps.action.outputs.is_rebuild }}
      must_build: ${{ steps.action.outputs.must_build }}
      is_deploy_flow: ${{ steps.action.outputs.is_deploy_flow }}
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/deploy-pr-preview/1-task@HCA-NA-add-huma-server-actions
        id: action
        with:
          must_build: ${{ env.must_build }}

  deploy-check:
    if: ${{ needs.deploy-task.outputs.is_deploy_flow == 'true' }}
    needs: deploy-task
    name: Check is /deploy or /rebuild
    runs-on: ubuntu-latest
    outputs:
      head_ref: ${{ steps.action.outputs.head_ref }}
      head_sha: ${{ steps.action.outputs.head_sha }}
      short_sha: ${{ steps.action.outputs.short_sha }}
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/deploy-pr-preview/2-check@HCA-NA-add-huma-server-actions
        id: action
        if: ${{ github.event.issue.pull_request
          && github.event.issue.state == 'open' }}
        with:
          issue_number: ${{ env.issue_number }}
          is_deployed: ${{ needs.deploy-task.outputs.is_deploy }}
          is_rebuild: ${{ needs.deploy-task.outputs.is_rebuild }}

  deploy-chart:
    name: Package and upload the Helm chart
    needs:
      - deploy-check
      - deploy-task
    if: ${{ needs.deploy-task.outputs.is_deploy_flow == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.helm.outputs.version }}
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/deploy-pr-preview/3-package-upload-helm-chart@HCA-NA-add-huma-server-actions
        name: Deploy the Helm chart to GKE
        id: helm
        with:
          head_sha: ${{ needs.deploy-check.outputs.head_sha }}
          include_sdk: ${{ inputs.include_sdk }}
          sdk_ref: ${{ inputs.sdk_ref }}
          sdk_ssh_key: ${{ secrets.SSH_KEY_TO_HUMA_SERVER_SDK }}
          short_sha: ${{ needs.deploy-check.outputs.short_sha }}
          update_chart: ${{ env.update_chart }}
          bucket_provider: ${{ env.bucket_provider }}
          server_extra_config_file: ${{ inputs.server_extra_config_file }}

  deploy-build:
    if: ${{ needs.deploy-task.outputs.is_deploy_flow == 'true' &&
      needs.deploy-task.outputs.must_build == 'true' }}
    needs:
      - deploy-check
      - deploy-task
    name: Build and Push Container
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/deploy-pr-preview/4-build@HCA-NA-add-huma-server-actions
        with:
          include_sdk: ${{ inputs.include_sdk }}
          sdk_ref: ${{ inputs.sdk_ref }}
          sdk_ssh_key: ${{ secrets.SSH_KEY_TO_HUMA_SERVER_SDK }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          make_build_push_ghcr: ${{ inputs.make_build_push_ghcr }}
          issue_number: ${{ env.issue_number }}
          head_sha: ${{ needs.deploy-check.outputs.head_sha }}
          head_ref: ${{ needs.deploy-check.outputs.head_ref }}

  deploy-deploy:
    name: Deploy the infrastructure Helm chart to GKE
    needs:
      - deploy-check
      - deploy-chart
      - deploy-task
    if: ${{ needs.deploy-task.outputs.is_deploy_flow == 'true' &&
      needs.deploy-task.outputs.must_build == 'true' }}
    outputs:
      dashboard_url: ${{ steps.deploy.outputs.dashboard_url }}
      error: ${{ steps.deploy.outputs.error }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/deploy-pr-preview/5-deploy-helm-to-gke@HCA-NA-add-huma-server-actions
        id: deploy
        with:
          app_name: ${{ env.app_name }}
          atlas_cluster: ${{ inputs.atlas_cluster }}
          atlas_project: ${{ inputs.atlas_project }}
          app_namespace: ${{ env.app_namespace }}
          bucket_provider: ${{ env.bucket_provider }}
          chart_url: oci://ghcr.io/huma-engineering/helm-charts/huma-backend-requisites
          clean_workload: "true"
          cluster_name: ${{ inputs.cluster_name }}
          db_provider: ${{ env.db_provider }}
          gcp_credentials: ${{ secrets.GKE_SA_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          image_repository: ghcr.io/huma-engineering/${{ inputs.docker_image_name }}
          image_tag_format: ${{ inputs.docker_temp_tag_format }}
          kubedb_namespace: ${{ inputs.kubedb_namespace }}
          kubedb_cluster: ${{ inputs.kubedb_cluster }}
          location: ${{ inputs.cluster_location }}
          version: ${{ needs.deploy-chart.outputs.version }}
          helm_extra_values_file: ${{ inputs.helm_extra_values_file }}
          server_py: ${{ inputs.server_py }}
          short_sha: ${{ needs.deploy-check.outputs.short_sha }}
          issue_number: ${{ env.issue_number }}
          head_sha: ${{ needs.deploy-check.outputs.head_sha }}
          chart_version: ${{ needs.deploy-chart.outputs.version }}
          is_deployed: ${{ needs.deploy-task.outputs.is_deploy }}
          grafana_api_key: ${{ secrets.PR_PREVIEW_GRAFANA_API_KEY }}

  deploy-restore-db:
    name: Restore MongoDB dump
    needs:
     - deploy-deploy
     - deploy-task
    if: ${{ needs.deploy-task.outputs.is_deploy == 'true' }}
    outputs:
      error: ${{ steps.restore.outputs.error }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/deploy-pr-preview/6-restore-db@HCA-NA-add-huma-server-actions
        id: restore
        with:
          issue_number: ${{ env.issue_number }}
          app_namespace: ${{ env.app_namespace }}
          full_db_dump_prefix: ${{ env.full_db_dump_prefix }}
          source_db_name: ${{ env.source_db_name }}
          source_gcs_bucket: ${{ env.source_gcs_bucket }}
          db_dump_bucket_name: ${{ inputs.db_dump_bucket_name }}
          cluster_name: ${{ inputs.cluster_name }}
          db_provider: ${{ env.db_provider }}
          db_user: ${{ env.db_user }}
          cluster_location: ${{ inputs.cluster_location }}
          gke_sa_key: ${{ secrets.GKE_SA_KEY }}

  deploy-copy-bucket:
    name: Clone the selected source bucket to a new GCS or S3 bucket
    needs:
     - deploy-deploy
     - deploy-task
    if: ${{ needs.deploy-task.outputs.is_deploy == 'true' }}
    outputs:
      error: ${{ steps.copy-bucket.outputs.error }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/deploy-pr-preview/7-copy-bucket@HCA-NA-add-huma-server-actions
        id: copy-bucket
        with:
          cluster_name: ${{ inputs.cluster_name }}
          cluster_location: ${{ inputs.cluster_location }}
          app_namespace: ${{ env.app_namespace }}
          app_name: ${{ env.app_name }}
          gcp_credentials: ${{ secrets.GKE_SA_KEY }}
          source_bucket: ${{ env.source_s3_bucket }}
          aws_access_key_id: ${{ secrets.PR_PREVIEW_AWS_HUMA_SANDBOX_IAM_USER_KEY_ID }}
          aws_secret_access_key: ${{ secrets.PR_PREVIEW_AWS_HUMA_SANDBOX_IAM_USER_SECRET_KEY }}
          aws_region: ${{ inputs.aws_region }}
          bucket_provider: ${{ env.bucket_provider }}
          issue_number: ${{ env.issue_number }}
          source_gcs_bucket: ${{ env.source_gcs_bucket }}

  deploy-report:
    if: ${{ needs.deploy-task.outputs.is_deploy == 'true' &&
      needs.deploy-deploy.outputs.error == 0 &&
      needs.deploy-restore-db.outputs.error == 0 &&
      needs.deploy-copy-bucket.outputs.error == 0 }}
    name: Send a preview URL to user
    needs:
      - deploy-build
      - deploy-restore-db
      - deploy-copy-bucket
      - deploy-task
      - deploy-check
      - deploy-deploy
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/deploy-pr-preview/8-report@HCA-NA-add-huma-server-actions
        with:
          cluster_name: ${{ inputs.cluster_name }}
          cluster_location: ${{ inputs.cluster_location }}
          include_sdk: ${{ inputs.include_sdk }}
          sdk_ref: ${{ inputs.sdk_ref }}
          sdk_ssh_key: ${{ secrets.SSH_KEY_TO_HUMA_SERVER_SDK  }}
          gke_sa_key: ${{ secrets.GKE_SA_KEY }}
          update_chart: ${{ inputs.update_chart }}
          server_name: ${{ inputs.server_name }}
          grafana_host: ${{ inputs.grafana_host }}
          atlas_project_url: ${{ inputs.atlas_project_url }}
          atlas_project: ${{ inputs.atlas_project }}
          atlas_cluster: ${{ inputs.atlas_cluster }}
          app_namespace: ${{ env.app_namespace }}
          app_name: ${{ env.app_name }}
          db_user: ${{ env.db_user }}
          host_postfix: ${{ env.host_postfix }}
          db_provider: ${{ env.db_provider }}
          bucket_provider: ${{ env.bucket_provider }}
          issue_number: ${{ env.issue_number }}
          head_sha: ${{ needs.deploy-check.outputs.head_sha }}
          dashboard_url: ${{ needs.deploy-deploy.outputs.dashboard_url }}

  # /destroy flow
  cleanup:
    if: ${{ (github.event.action == 'created' && github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/destroy')) || github.event.action == 'closed' &&
      contains(github.event.pull_request.labels.*.name, 'deployed') }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/cleanup-pr-preview@HCA-NA-add-huma-server-actions
        with:
          server_name: ${{ inputs.server_name }}
          grafana_host: ${{ inputs.grafana_host }}
          cluster_name: ${{ inputs.cluster_name }}
          cluster_location: ${{ inputs.cluster_location }}
          issue_number: ${{ env.issue_number }}
          gke_sa_key: ${{ secrets.GKE_SA_KEY }}
          grafana_api_key: ${{ secrets.PR_PREVIEW_GRAFANA_API_KEY }}

  # /rebase flow
  rebase:
    name: Automatic Rebase
    if: ${{ github.event.issue.pull_request != '' &&
      contains(github.event.comment.body, '/rebase') }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/rebase@HCA-NA-add-huma-server-actions
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # mongo automatic dumps
  dump-mongo-dev-full:
    if: ${{ inputs.dev_mongo_db_name != '' && github.event.schedule != '' && !endsWith(github.event.schedule, '1-5') }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-github-actions/dump-mongodb-db-to-bucket@v0.19.1
        with:
          bucket_name: ${{ inputs.db_dump_bucket_name }}
          archive_name: ${{ inputs.server_name }}_full_dump_hs_sandbox_dev.gz
          db_uri: ${{ env.mongo_dev_uri }}
          gcp_credentials: ${{ secrets.GKE_SA_KEY }}
          vpn_username: ${{ secrets.VPN_USERNAME }}
          vpn_password: ${{ secrets.VPN_PASSWORD }}
          vpn_config_url: ${{ env.vpn_config_url }}
          vpn_check_internal_domain: hu-pre-prod-london.wjabo.gcp.mongodb.net
          dump_options: ''

  dump-mongo-dev-quick:
    # if: ${{ inputs.dev_mongo_db_name != '' && github.event.schedule != '' && endsWith(github.event.schedule, '1-5') }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/dump-mongodb-db-to-bucket@HCA-NA-add-huma-server-actions
#      - uses: huma-engineering/huma-github-actions/dump-mongodb-db-to-bucket@v0.19.1
        with:
          bucket_name: ${{ inputs.db_dump_bucket_name }}
          archive_name: ${{ inputs.server_name }}_quick_dump_hs_sandbox_dev.gz
          db_uri: ${{ env.mongo_dev_uri }}
          gcp_credentials: ${{ secrets.GKE_SA_KEY }}
          vpn_username: ${{ secrets.VPN_USERNAME }}
          vpn_password: ${{ secrets.VPN_PASSWORD }}
          vpn_config_url: ${{ env.vpn_config_url }}
          # vpn_check_internal_domain: hu-gcp-staging-cluster-pl-0.o7bwx.mongodb.net
          vpn_check_internal_domain: hu-pre-prod-london.wjabo.gcp.mongodb.net
          dump_options: '--excludeCollection=deploymentrevision --excludeCollection=auditlog ${{ inputs.mongo_dump_extra_options }}'

  dump-mongo-qa-full:
    if: ${{ inputs.qa_mongo_db_name != '' && github.event.schedule != '' && !endsWith(github.event.schedule, '1-5') }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-github-actions/dump-mongodb-db-to-bucket@v0.19.1
        with:
          bucket_name: ${{ inputs.db_dump_bucket_name }}
          archive_name: ${{ inputs.server_name }}_full_dump_hs_sandbox_qa.gz
          db_uri: ${{ env.mongo_qa_uri }}
          gcp_credentials: ${{ secrets.GKE_SA_KEY }}
          vpn_username: ${{ secrets.VPN_USERNAME }}
          vpn_password: ${{ secrets.VPN_PASSWORD }}
          vpn_config_url: ${{ env.vpn_config_url }}
          vpn_check_internal_domain: hu-pre-prod-london.wjabo.gcp.mongodb.net
          dump_options: ''

  dump-mongo-qa-quick:
    if: ${{ inputs.qa_mongo_db_name != '' && github.event.schedule != '' && endsWith(github.event.schedule, '1-5') }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-github-actions/dump-mongodb-db-to-bucket@v0.19.1
        with:
          bucket_name: ${{ inputs.db_dump_bucket_name }}
          archive_name: ${{ inputs.server_name }}_quick_dump_hs_sandbox_qa.gz
          db_uri: ${{ env.mongo_qa_uri }}
          gcp_credentials: ${{ secrets.GKE_SA_KEY }}
          vpn_username: ${{ secrets.VPN_USERNAME }}
          vpn_password: ${{ secrets.VPN_PASSWORD }}
          vpn_config_url: ${{ env.vpn_config_url }}
          vpn_check_internal_domain: hu-pre-prod-london.wjabo.gcp.mongodb.net
          dump_options: '--excludeCollection=deploymentrevision --excludeCollection=auditlog ${{ inputs.mongo_dump_extra_options }}'

  run-migration:
    if: ${{ github.event.issue.pull_request
      && github.event.issue.state == 'open'
      && startsWith(github.event.comment.body, '/run-migration') }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/run-migration@HCA-NA-add-huma-server-actions
        with:
          app_namespace: ${{ env.app_namespace }}
          cluster_name: ${{ inputs.cluster_name }}
          cluster_location: ${{ inputs.cluster_location }}
          migrate_py: ${{ inputs.migrate_py }}
          migrate_config: ${{ inputs.migrate_config }}
          has_deploy_tag: ${{ contains(github.event.issue.labels.*.name, 'deployed') }}
          gke_sa_key: ${{ secrets.GKE_SA_KEY }}

  change-logs:
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release-') }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/change-logs@HCA-NA-add-huma-server-actions
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          include_sdk: ${{ inputs.include_sdk }}
          sdk_ref: ${{ inputs.sdk_ref }}
          sdk_ssh_key: ${{ secrets.SSH_KEY_TO_HUMA_SERVER_SDK }}
          version_py: ${{ inputs.version_py }}

  help-pr-preview:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened' }}
    runs-on: ubuntu-latest
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/help-pr-preview@HCA-NA-add-huma-server-actions

  # /publishing to dev and QA
  publish-task:
    name: Check if this flow must be run at all or not
    runs-on: ubuntu-latest
    outputs:
      is_publish_task: ${{ steps.action.outputs.is_publish_task }}
    steps:
      - id: check
        run: |-
          echo "::set-output name=is_publish_task::${{ env.is_publish_task }}"

  publish-tests:
    needs: publish-task
    if: ${{ needs.publish-task.outputs.is_publish_task }}
    name: Run tests
    runs-on: ubuntu-20.04
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/publish-dev-qa/1-tests@HCA-NA-add-huma-server-actions
        with:
          server_name: ${{ inputs.server_name }}
          include_sdk: ${{ inputs.include_sdk }}
          sdk_ref: ${{ inputs.sdk_ref }}
          sdk_ssh_key: ${{ secrets.SSH_KEY_TO_HUMA_SERVER_SDK }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  publish-coverage-results:
    needs:
     - publish-tests
     - publish-task
    if: ${{ needs.publish-task.outputs.is_publish_task && success() }}
    name: Publish coverage results
    runs-on: ubuntu-20.04
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/publish-dev-qa/2-publish-coverage-results@HCA-NA-add-huma-server-actions

  publish-test-results:
    needs:
     - publish-tests
     - publish-task
    if: ${{ needs.publish-task.outputs.is_publish_task && success() }}
    name: Publish test results
    runs-on: ubuntu-20.04
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/publish-dev-qa/3-publish-test-results@HCA-NA-add-huma-server-actions

  publish-build-and-push:
    needs:
     - publish-tests
     - publish-task
    if: ${{ needs.publish-task.outputs.is_publish_task && success() }}
    name: Build and push py-${{ inputs.server_name }} image
    runs-on: ubuntu-20.04
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/publish-dev-qa/4-build-and-push@HCA-NA-add-huma-server-actions
        with:
          server_name: ${{ inputs.server_name }}
          include_sdk: ${{ inputs.include_sdk }}
          sdk_ref: ${{ inputs.sdk_ref }}
          sdk_ssh_key: ${{ secrets.SSH_KEY_TO_HUMA_SERVER_SDK }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  publish-deploy-to-dev:
    needs:
     - publish-build-and-push
     - publish-task
    if: ${{ needs.publish-task.outputs.is_publish_task && success() }}
    name: Update DEV env
    runs-on: ubuntu-20.04
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/publish-dev-qa/5-deploy@HCA-NA-add-huma-server-actions
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          vpn_username: ${{ secrets.VPN_USERNAME }}
          vpn_password: ${{ secrets.VPN_PASSWORD }}
          vpn_config_url: ${{ env.vpn_config_url }}
          kubeconfig: ${{ secrets.GCP_UK_DEV_KUBECONFIG }}
          env: dev

  publish-deploy-to-qa:
    needs:
     - publish-build-and-push
     - publish-task
    if: ${{ needs.publish-task.outputs.is_publish_task && success() }}
    name: Update QA env
    environment: QA
    runs-on: ubuntu-20.04
    steps:
      - uses: huma-engineering/huma-common-actions/server-ci/actions/publish-dev-qa/5-deploy@HCA-NA-add-huma-server-actions
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          vpn_username: ${{ secrets.VPN_USERNAME }}
          vpn_password: ${{ secrets.VPN_PASSWORD }}
          vpn_config_url: ${{ env.vpn_config_url }}
          kubeconfig: ${{ secrets.GCP_UK_DEV_KUBECONFIG }}
          env: qa
